<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task 5: API App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/style.css">
</head>
<body>

    <nav class="navbar navbar-expand navbar-dark">
        <div class="container justify-content-center">
            <div class="navbar-nav bg-dark rounded-pill px-4 py-2 shadow-lg">
                <a class="nav-link mx-2 active" onclick="navigate('home')">Dashboard</a>
                <a class="nav-link mx-2" onclick="navigate('about')">About</a>
            </div>
        </div>
    </nav>

    <div class="container mt-5 pt-5">
        <div class="row justify-content-center">
            
            <div id="home" class="route-section active w-100">
                <div class="row justify-content-center">
                    
                    <div class="col-md-5 mb-4">
                        <div class="card card-custom p-4">
                            <h3 class="text-center mb-3">Registration Form(via API)</h3>
                            
                            <form id="apiForm" onsubmit="handleApiSubmit(event)">
                                <div class="mb-3">
                                    <label class="small text-muted">Username</label>
                                    <input type="text" class="form-control" id="username" required>
                                </div>
                                <div class="mb-3">
                                    <label class="small text-muted">Email</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                <div class="mb-3">
                                    <label class="small text-muted">Age</label>
                                    <input type="number" class="form-control" id="age" required>
                                </div>

                                <div class="mb-3">
                                    <label class="small text-muted">Password</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="password" oninput="checkStrength()" required>
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div id="meter-bar" class="strength-meter"></div>
                                    <div class="d-flex justify-content-between mt-1">
                                        <small id="strength-text" class="text-muted" style="font-size: 12px;">Strength: None</small>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary w-100 mt-2">Create User</button>
                            </form>
                            <div id="statusMessage" class="mt-3 text-center"></div>
                        </div>
                    </div>

                    <div class="col-md-5">
                        <div class="card card-custom p-4 h-100">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 class="mb-0">Live Database</h4>
                                <button onclick="fetchUsers()" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                            <ul id="userList" class="list-group list-group-flush" style="overflow-y: auto; max-height: 400px;">
                                <li class="list-group-item text-muted text-center">Loading...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="about" class="route-section">
                <div class="col-md-8 mx-auto">
                    <div class="card card-custom p-5 text-center">
                        <h3 class="text-primary mb-3">About This App</h3>
                        <p class="lead">This is a Full-Stack Single Page Application.</p>
                        <hr class="my-4">
                        <ul class="text-start text-muted mx-auto" style="max-width: 400px;">
                            <li><strong>Frontend:</strong> EJS, Bootstrap 5, JavaScript (Fetch API)</li>
                            <li><strong>Backend:</strong> Node.js, Express</li>
                            <li><strong>Features:</strong> API Integration, Live Validation, Routing</li>
                        </ul>
                        <button class="btn btn-outline-primary mt-4" onclick="navigate('home')">Back to Dashboard</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        /* --- 1. TAB NAVIGATION --- */
        function navigate(sectionId) {
            // Hide all sections
            document.querySelectorAll('.route-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));

            // Show target section
            document.getElementById(sectionId).classList.add('active');
            
            // Highlight button
            if(sectionId === 'home') document.querySelector('.nav-link[onclick="navigate(\'home\')"]').classList.add('active');
            if(sectionId === 'about') document.querySelector('.nav-link[onclick="navigate(\'about\')"]').classList.add('active');
        }

        /* --- 2. PASSWORD UX (Toggle & Meter) --- */
        function togglePassword() {
            const input = document.getElementById('password');
            const icon = document.querySelector('.bi-eye, .bi-eye-slash'); // Find whichever icon is currently there
            
            if (input.type === "password") {
                input.type = "text";
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
            } else {
                input.type = "password";
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
            }
        }

        function checkStrength() {
            const password = document.getElementById('password').value;
            const meter = document.getElementById('meter-bar');
            const text = document.getElementById('strength-text');

            let strength = 0;
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;

            const width = (strength / 4) * 100;
            meter.style.width = width + "%";

            if (strength <= 1) { 
                meter.style.backgroundColor = "#ff4d4d"; 
                text.innerText = "Weak"; text.style.color = "#ff4d4d"; 
            } else if (strength <= 3) { 
                meter.style.backgroundColor = "#ffc107"; 
                text.innerText = "Medium"; text.style.color = "#ffc107"; 
            } else { 
                meter.style.backgroundColor = "#28a745"; 
                text.innerText = "Strong"; text.style.color = "#28a745"; 
            }
        }

        /* --- 3. VALIDATION --- */
        function validateForm() {
            const password = document.getElementById('password').value;
            // Strict Regex: 8 chars, 1 Upper, 1 Number, 1 Symbol
            const strictRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;

            if (!strictRegex.test(password)) {
                alert("Password too weak!\n- Min 8 chars\n- 1 Uppercase\n- 1 Number\n- 1 Symbol");
                return false;
            }
            return true;
        }

        /* --- 4. API HANDLING --- */
        async function handleApiSubmit(event) {
            event.preventDefault(); // Stop page reload
            
            // RUN VALIDATION FIRST
            if (!validateForm()) return; // If password is bad, stop here.

            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = '<span class="text-warning">Sending...</span>';

            const userData = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                age: document.getElementById('age').value,
                password: document.getElementById('password').value
            };

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (response.ok) {
                    statusDiv.innerHTML = '<span class="text-success fw-bold">Success! User Added.</span>';
                    document.getElementById('apiForm').reset();
                    // Reset meter manually
                    document.getElementById('meter-bar').style.width = '0%';
                    document.getElementById('strength-text').innerText = 'Strength: None';
                    
                    fetchUsers(); // Refresh list
                } else {
                    statusDiv.innerHTML = `<span class="text-danger">Error: ${result.error}</span>`;
                }
            } catch (err) {
                console.error(err);
                statusDiv.innerText = "API Connection Failed";
            }
        }

        async function fetchUsers() {
            const list = document.getElementById('userList');
            try {
                const response = await fetch('/api/users');
                const users = await response.json();

                list.innerHTML = '';
                if (users.length === 0) {
                    list.innerHTML = '<li class="list-group-item text-muted text-center">No users found.</li>';
                    return;
                }

                users.forEach(user => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center animate-fade-in';
                    li.innerHTML = `
                        <span>
                            <span class="fw-bold text-dark">${user.username}</span>
                            <br><small class="text-muted">${user.email}</small>
                        </span>
                        <span class="badge bg-secondary rounded-pill">${user.age}</span>
                    `;
                    list.appendChild(li);
                });
            } catch (err) { console.error(err); }
        }

        // Initialize
        fetchUsers();
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>